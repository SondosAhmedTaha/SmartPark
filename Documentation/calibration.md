# 🎛️ Calibration Guide - מדריך כיול

מדריך זה מסביר כיצד לכייל את חיישני המרחק (HC-SR04) למערכת החניה החכמה.

---

## 📏 למה צריך כיול?

חיישני HC-SR04 צריכים כיול בגלל:
- **גובה התקנה שונה** - כל התקנה בגובה שונה דורשת ספי מרחק שונים
- **סוג רכב** - מכוניות שונות (סדאן, SUV, מיני) בגבהים שונים
- **רעש סביבתי** - משטחים מחזירי קול, טמפרטורה
- **דיוק** - למנוע false positives (זיהויים שגויים)

---

## 🔧 כלים נדרשים

- ✅ סרגל מדידה / מטר (עד 50 ס"מ לפחות)
- ✅ ESP32 מחובר + Serial Monitor
- ✅ אובייקט בגודל דומה לרכב (קופסה, ספר עבה)
- ✅ משטח יציב להתקנת החיישן

---

## 📐 שלב 1: קביעת גובה התקנה

### 1.1 גובה אופטימלי

```
                    ┌─────────────┐
                    │  HC-SR04    │  ← גובה: 15-30 ס"מ מהקרקע
                    └──────┬──────┘
                           │
                        ┌──┴──┐
                        │ °   │  ← קרן אולטרסונית (זווית 15°)
                        └─────┘
                           │
        ═══════════════════╧═══════════════════
                       קרקע / שולחן
```

**המלצות:**
- **גובה נמוך (10-15 ס"מ)**: רגיש יותר, אבל עלול לזהות רצפה
- **גובה בינוני (15-25 ס"מ)**: מאזן טוב (מומלץ)
- **גובה גבוה (25-35 ס"מ)**: פחות רגיש, מתאים לרכבים גדולים

**בחר גובה והתקן את החיישן בצורה יציבה!**

---

### 1.2 קביעת זווית

```
אופקי (מומלץ):
  HC-SR04
  ┌────┐
  │ °° │ ────→  (זווית 0°)
  └────┘

מוטה מעט (אם יש מכשול):
  ┌────┐
  │ °° │
  └────┘\
        ↘  (זווית 10-15°)
```

**טיפ:** שמור על החיישן אופקי (0°) למרחקים מדויקים.

---

## 🧪 שלב 2: מדידת מרחקים ממשיים

### 2.1 פתיחת Serial Monitor

```bash
# Arduino IDE → Tools → Serial Monitor
# Baud Rate: 115200
```

### 2.2 מדידת "חנייה ריקה"

1. **הסר כל אובייקטים** מול החיישן (לפחות 50 ס"מ)

2. **קרא מ-Serial Monitor:**
   ```
   Distance: 45
   Distance: 47
   Distance: 46
   Distance: 48
   ```

3. **רשום את הערך הממוצע:**
   ```
   ריק = ~47 ס"מ
   ```

---

### 2.3 מדידת "רכב חונה"

1. **הנח אובייקט** (קופסה/ספר) במרחק שמייצג "רכב":
   - **מרחק טיפוסי:** 5-15 ס"מ מהחיישן

2. **קרא מ-Serial Monitor:**
   ```
   Distance: 8
   Distance: 9
   Distance: 8
   Distance: 7
   ```

3. **רשום את הערך הממוצע:**
   ```
   תפוס = ~8 ס"מ
   ```

---

### 2.4 מדידת "רכב בדרך" (חצי שם)

1. **הנח אובייקט במרחק ביניים** (~20-25 ס"מ):

2. **קרא:**
   ```
   Distance: 22
   Distance: 23
   Distance: 21
   ```

3. **רשום:**
   ```
   ביניים = ~22 ס"מ
   ```

---

## 🎯 שלב 3: חישוב סף אופטימלי

### 3.1 נוסחת חישוב

```
THRESH_ENTER = (ערך_תפוס_ממוצע) + 3-5 ס"מ
THRESH_EXIT  = THRESH_ENTER + 5-8 ס"מ
```

**דוגמה מהמדידות שלנו:**
```
תפוס = 8 ס"מ
ביניים = 22 ס"מ
ריק = 47 ס"מ

THRESH_ENTER = 8 + 4 = 12 ס"מ
THRESH_EXIT  = 12 + 6 = 18 ס"מ
```

---

### 3.2 טבלת כיול לפי גובה התקנה

| גובה חיישן | מרחק תפוס | THRESH_ENTER | THRESH_EXIT |
|------------|-----------|--------------|-------------|
| **10 ס"מ** | 3-5 ס"מ | 8 ס"מ | 15 ס"מ |
| **15 ס"מ** | 5-8 ס"מ | 10 ס"מ | 17 ס"מ |
| **20 ס"מ** | 7-10 ס"מ | 12 ס"מ | 18 ס"מ |
| **25 ס"מ** | 10-15 ס"מ | 15 ס"מ | 22 ס"מ |
| **30 ס"מ** | 15-20 ס"מ | 18 ס"מ | 25 ס"מ |

**בחר לפי גובה ההתקנה שלך!**

---

## ⚙️ שלב 4: עדכון הקוד

### 4.1 עריכת ESP32/SpotNode/SpotNode.ino

פתח את הקובץ וערוך שורות 34-35:

```cpp
// ========== Distance Thresholds (cm) ==========
const int THRESH_ENTER = 12;        // ← שנה כאן!
const int THRESH_EXIT = 18;         // ← שנה כאן!
```

**דוגמה - חיישן בגובה 25 ס"מ:**
```cpp
const int THRESH_ENTER = 15;  // מ-12 ל-15
const int THRESH_EXIT = 22;   // מ-18 ל-22
```

---

### 4.2 שמירה והעלאה

```bash
# שמור את הקובץ (Ctrl+S)
# Upload ל-ESP32 (Ctrl+U)
```

---

### 4.3 אימות בדיקה

```bash
# Serial Monitor - בדוק שהערכים משתנים:
Distance: 47  ← ריק
Distance: 21  ← ביניים (עדיין FREE)
Distance: 14  ← מתחת ל-THRESH_ENTER → OCCUPIED!
Distance: 19  ← מעל THRESH_EXIT → FREE!
```

---

## 🔬 שלב 5: כיול מתקדם - Hysteresis

### 5.1 מהו Hysteresis?

**בעיה:**
```
מרחק נע בין 17-19 ס"מ:
Distance: 17 → OCCUPIED
Distance: 19 → FREE
Distance: 17 → OCCUPIED  ← "רפרוף" (flickering)
```

**פתרון: Hysteresis (הפרש בין סף כניסה ויציאה)**

```cpp
THRESH_ENTER = 12 ס"מ  ← נכנס רק כשמתחת ל-12
THRESH_EXIT  = 18 ס"מ  ← יוצא רק כשמעל 18

פער = 18 - 12 = 6 ס"מ  ← "אזור מת" למניעת רפרוף
```

---

### 5.2 כיול Hysteresis

**כלל אצבע:**
```
THRESH_EXIT - THRESH_ENTER ≥ 5 ס"מ
```

**דוגמאות:**

| תרחיש | ENTER | EXIT | Hysteresis | טוב/רע |
|-------|-------|------|------------|--------|
| רעש נמוך | 12 | 16 | 4 ס"מ | ⚠️ קצר |
| מומלץ | 12 | 18 | 6 ס"מ | ✅ טוב |
| רעש גבוה | 12 | 20 | 8 ס"מ | ✅ מעולה |
| יתר על המידה | 12 | 25 | 13 ס"מ | ⚠️ איטי |

**אם יש "רפרוף":** הגדל את ההפרש ל-8-10 ס"מ.

---

## ⏱️ שלב 6: כיול STABLE_TIME

### 6.1 מהו STABLE_TIME?

זמן שהמרחק צריך להישאר יציב **לפני** עדכון ב-Firebase.

```cpp
const unsigned long STABLE_TIME = 3000;  // 3 שניות
```

**תרחיש:**
```
t=0s:  Distance: 10 → desired=OCCUPIED
t=1s:  Distance: 9  → desired=OCCUPIED (עדיין יציב)
t=2s:  Distance: 11 → desired=OCCUPIED (עדיין יציב)
t=3s:  ✅ 3 שניות עברו → Firebase.update("OCCUPIED")
```

---

### 6.2 התאמת STABLE_TIME

| סוג חיישן | STABLE_TIME | שימוש |
|-----------|-------------|-------|
| רגיש/רועש | 5000 ms (5s) | מניעת false positives |
| רגיל | 3000 ms (3s) | ברירת מחדל (מומלץ) |
| מהיר | 1500 ms (1.5s) | תגובה מהירה |
| בדיקות | 500 ms (0.5s) | Debug בלבד |

**עריכה:**
```cpp
// ESP32/SpotNode/SpotNode.ino - שורה 304
const unsigned long STABLE_TIME = 3000;  // ← שנה כאן
```

---

## 🧮 שלב 7: כיול מתקדם - Timeout

### 7.1 Timeout של pulseIn()

```cpp
// ESP32/SpotNode/SpotNode.ino - readDistanceCM()
long duration = pulseIn(ECHO_PIN, HIGH, 30000);  // 30ms timeout
```

**מה זה עושה?**
- מחכה עד **30 ms** לתגובה מהחיישן
- אם אין תגובה → מחזיר `-1` (שגיאה)

---

### 7.2 התאמת Timeout

```cpp
// למרחקים קצרים (עד 50 ס"מ):
long duration = pulseIn(ECHO_PIN, HIGH, 20000);  // 20ms

// למרחקים ארוכים (עד 2 מטר):
long duration = pulseIn(ECHO_PIN, HIGH, 50000);  // 50ms

// ברירת מחדל (עד 1.5 מטר):
long duration = pulseIn(ECHO_PIN, HIGH, 30000);  // 30ms ✅
```

**חישוב:**
```
מהירות קול = 343 m/s = 0.0343 cm/μs
זמן עבור 1 מטר (הלוך-חזור): ~5800 μs = 5.8 ms

למרחק 50 ס"מ: 50 × 2 / 0.0343 = 2915 μs ≈ 3 ms
→ Timeout של 20ms מספיק
```

---

## 📊 שלב 8: בדיקה וולידציה

### 8.1 טבלת בדיקה

הדפס טבלה זו ומלא בזמן הכיול:

| מבחן | מרחק מצופה | מרחק נמדד | סטטוס מצופה | סטטוס בפועל | ✅/❌ |
|------|-----------|-----------|-------------|--------------|------|
| 1. ריק לגמרי | >30 ס"מ | ____ | FREE | ____ | ___ |
| 2. אובייקט קרוב | <10 ס"מ | ____ | OCCUPIED | ____ | ___ |
| 3. אובייקט רחוק | >20 ס"מ | ____ | FREE | ____ | ___ |
| 4. כניסה לאט | 20→8 ס"מ | ____ | FREE→OCC | ____ | ___ |
| 5. יציאה לאט | 8→25 ס"מ | ____ | OCC→FREE | ____ | ___ |
| 6. רפרוף (17-19) | ~18 ס"מ | ____ | יציב | ____ | ___ |

**יעד:** כל השורות עם ✅

---

### 8.2 בדיקת יציבות (Stability Test)

```bash
# הרץ למשך 5 דקות עם אובייקט קבוע במקום
# Serial Monitor צריך להראות:

Distance: 8
Distance: 8
Distance: 8  ← ללא שינויים פתאומיים
Distance: 9
Distance: 8
```

**אם יש קפיצות (jumps):**
```
Distance: 8
Distance: 47  ← קפיצה!
Distance: 8
```

**פתרונות:**
1. הגדל `STABLE_TIME` ל-5000 ms
2. בדוק חיווט (כבלים קצרים!)
3. הוסף קבל 100nF בין VCC-GND של החיישן

---

## 🎯 ערכים מומלצים סופיים

### תצורה סטנדרטית (מומלצת לרוב המקרים):

```cpp
// ========== Recommended Settings ==========
const int TRIG_PIN = 5;
const int ECHO_PIN = 18;

const int THRESH_ENTER = 12;        // ס"מ
const int THRESH_EXIT = 18;         // ס"מ

const unsigned long STABLE_TIME = 3000;     // ms
const unsigned long POLL_INTERVAL = 3000;   // ms

// readDistanceCM():
long duration = pulseIn(ECHO_PIN, HIGH, 30000);  // 30ms
return duration / 58;  // המרה ל-ס"מ
```

**זה אמור לעבוד ב-90% מהמקרים!**

---

## 🔧 Troubleshooting כיול

### בעיה: מרחקים לא עקביים

**תסמינים:**
```
Distance: 10
Distance: 45
Distance: 8
Distance: 200
```

**פתרון:**
1. ✅ בדוק חיווט - TRIG/ECHO מחוברים נכון?
2. ✅ כבלים קצרים (<20 ס"מ)
3. ✅ הוסף קבל 100nF על VCC-GND
4. ✅ החלף חיישן (ייתכן פגום)

---

### בעיה: תמיד OCCUPIED (גם כשריק)

**תסמינים:**
```
Distance: 5
Distance: 4
Distance: 6
```

**גורם:** החיישן מצביע לקרקע/שולחן!

**פתרון:**
1. ✅ הרם את החיישן בעוד 5-10 ס"מ
2. ✅ הטה מעט כלפי מעלה (5-10°)
3. ✅ שנה `THRESH_ENTER` ל-8 במקום 12

---

### בעיה: תמיד FREE (גם כשתפוס)

**תסמינים:**
```
Distance: 45
Distance: 47
Distance: 50
```

**גורם:** החיישן לא "רואה" את האובייקט!

**פתרון:**
1. ✅ בדוק שהאובייקט בזווית 15° מהחיישן
2. ✅ הנמך את החיישן ל-15-20 ס"מ
3. ✅ שנה `THRESH_ENTER` ל-20 במקום 12

---

### בעיה: "רפרוף" - מתחלף כל שנייה

**תסמינים:**
```
[0s] status -> FREE
[1s] status -> OCCUPIED
[2s] status -> FREE
[3s] status -> OCCUPIED
```

**פתרון:**
1. ✅ הגדל Hysteresis: `THRESH_EXIT = THRESH_ENTER + 8`
2. ✅ הגדל `STABLE_TIME` ל-5000 ms
3. ✅ בדוק רעשים חשמליים (נסה ללא USB - רק סוללה)

---

## 📝 רישום כיול (Calibration Log)

**מלא ושמור למעקב:**

```
תאריך: ___________
גובה חיישן: _______ ס"מ
זווית: _______ מעלות

מדידות:
  ריק: _______ ס"מ
  תפוס: _______ ס"מ
  ביניים: _______ ס"מ

הגדרות:
  THRESH_ENTER = _______
  THRESH_EXIT = _______
  STABLE_TIME = _______

בדיקות:
  ☐ ריק → FREE
  ☐ תפוס → OCCUPIED
  ☐ כניסה → FREE→OCC
  ☐ יציאה → OCC→FREE
  ☐ יציבות (5 דק')

הערות:
_________________________________
_________________________________
```

---

## 🎓 טיפים מתקדמים

### 1. שימוש במסנן ממוצע (Moving Average)

```cpp
// הוסף בראש הקובץ:
#define SAMPLES 5
long readings[SAMPLES];
int index = 0;

long readDistanceCM_Filtered() {
  readings[index] = readDistanceCM();
  index = (index + 1) % SAMPLES;
  
  long sum = 0;
  for (int i = 0; i < SAMPLES; i++) sum += readings[i];
  return sum / SAMPLES;
}
```

**יתרון:** מרחקים חלקים יותר, פחות רעש.

---

### 2. זיהוי שגיאות (Error Detection)

```cpp
long d = readDistanceCM();
if (d == -1 || d > 200) {
  Serial.println("⚠️ Sensor error - ignoring reading");
  return;  // התעלם מקריאה זו
}
```

---

### 3. כיול דינמי (Auto-Calibration)

```cpp
// למדוד "ריק" בעת הפעלה:
void setup() {
  // ... קוד רגיל ...
  
  long emptySum = 0;
  for (int i = 0; i < 10; i++) {
    emptySum += readDistanceCM();
    delay(100);
  }
  long emptyAvg = emptySum / 10;
  
  // קבע ספים אוטומטית:
  THRESH_ENTER = emptyAvg / 2;
  THRESH_EXIT = emptyAvg * 0.7;
  
  Serial.print("Auto-calibrated: ENTER=");
  Serial.print(THRESH_ENTER);
  Serial.print(" EXIT=");
  Serial.println(THRESH_EXIT);
}
```

---

## ✅ Checklist סיום כיול

- [ ] גובה חיישן נקבע (15-25 ס"מ)
- [ ] מדידות "ריק", "תפוס", "ביניים" בוצעו
- [ ] `THRESH_ENTER` ו-`THRESH_EXIT` חושבו
- [ ] Hysteresis ≥ 5 ס"מ
- [ ] `STABLE_TIME` נבחר (3000 ms ברירת מחדל)
- [ ] קוד עודכן והועלה ל-ESP32
- [ ] בדיקת "ריק" → FREE עברה
- [ ] בדיקת "תפוס" → OCCUPIED עברה
- [ ] בדיקת כניסה/יציאה עברה
- [ ] בדיקת יציבות (5 דק') עברה
- [ ] לא רפרוף במרחקים ביניים
- [ ] רישום כיול מולא ונשמר

---

**כיול מוצלח! 🎉**

המערכת מוכנה לשימוש. לבעיות, ראה [troubleshooting.md](troubleshooting.md).
